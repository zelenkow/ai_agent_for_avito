system_prompt = """
Ты — AI-ассистент для контроля качества коммуникации менеджеров в компании. 
Твоя задача — строго проанализировать диалог и вернуть ответ в формате JSON, без любых других пояснений до или после.
ВСЕГДА следуй предложенной схеме JSON.
ВСЕ части ответа, включая комментарии и рекомендации, ДОЛЖНЫ быть написаны на РУССКОМ ЯЗЫКЕ. ЗАПРЕЩЕНО использовать английские слова и термины.
"""

user_prompt_template = """
Проанализируй диалог менеджера с клиентом в чате "{chat_title}".
Учти, что [КЛИЕНТ] — это потенциальный покупатель, а [МЕНЕДЖЕР] — это сотрудник компании.

Сообщения от КОМПАНИИ помечены [МЕНЕДЖЕР], от КЛИЕНТА - [КЛИЕНТ].

ПРОАНАЛИЗИРУЙ СООБЩЕНИЯ [МЕНЕДЖЕР] и дай развернутую оценку по следующим критериям. Для каждого критерия дай ОБЩУЮ ОЦЕНКУ ("Высокая", "Средняя", "Низкая") и КРАТКОЕ ПОЯСНЕНИЕ на 1-2 предложения на русском языке.

КРИТЕРИИ:
1.  **Тональность коммуникации**: Общий эмоциональный настрой и вежливость.
2.  **Профессионализм**: Использование корректной терминологии, компетентность в вопросах.
3.  **Ясность изложения**: Насколько понятно, четко и структурировано менеджер доносит информацию.
4.  **Решение проблем**: Способность выявлять потребности клиента и предлагать релевантные решения.
5.  **Работа с возражениями**: Эффективность реакции на сомнения или негатив клиента. Если возражений не было, поставь оценку 'Нет возражений'.
6.  **Завершение диалога**: Была ли сделана попытка корректно завершить коммуникацию (зафиксировать следующий шаг, попрощаться).

"ВСЕ оценки, комментарии и рекомендации ДОЛЖНЫ БЫТЬ НАПИСАНЫ НА РУССКОМ ЯЗЫКЕ. ЗАПРЕЩЕНО использовать английские слова, заменяй их русскими аналогами."

В конце дай:
- **Итоговую оценку**: Краткое резюме на 1-3 предложения на русском языке.
- **Рекомендации**: 1-3 конкретных совета, что менеджер мог бы сделать лучше на русском языке

ВЕРНИ ОТВЕТ В ФОРМАТЕ JSON СТРОГО И ТОЧНО ПО СЛЕДУЮЩЕЙ СХЕМЕ. НЕ ДОБАВЛЯЙ никаких других полей.

{{
  "tonality": {{
    "grade": "Высокая",
    "comment": "Менеджер сохранял доброжелательный и уважительный тон на протяжении всего диалога."
  }},
  "professionalism": {{
    "grade": "Средняя", 
    "comment": "Использовал корректную терминологию, но не уточнил важные технические детали по установке."
  }},
  "clarity": {{
    "grade": "Высокая",
    "comment": "Ответы были четкими и по делу, клиенту было легко понять варианты и цены."
  }},
  "problem_solving": {{
    "grade": "Низкая",
    "comment": "Не предложил альтернативу при отказе клиента от дорогого варианта."
  }},
  "objection_handling": {{
    "grade": "Нет возражений", # Или "Высокая"/"Средняя"/"Низкая"
    "comment": "В диалоге возражений со стороны клиента не было."
  }},
  "closure": {{
    "grade": "Высокая",
    "comment": "Диалог завершен корректно, клиент приглашен для дальнейшего обращения."
  }},
  "summary": "Менеджер вежлив и коммуникабелен, но не проявил гибкости в продажах. Клиент ушел на подумать без конкретного решения.",
  "recommendations": "Отработать технику предложения альтернатив. Заранее готовить ответы на частые возражения по цене."
}}

ДИАЛОГ:
{formatted_dialog}
"""


async def save_deepseek_to_db(analysis_json, chat_id):
    """
    Args:
        analysis_json (str): JSON строка от Deepseek
        chat_id (str): ID чата для связи
        db_pool (asyncpg.Pool): Пул соединений с БД
    """
    
        # Парсим JSON строку в словарь
        analysis_data = json.loads(analysis_json)
        
        query = """
            INSERT INTO chat_reports (
                chat_id, tonality_grade, tonality_comment,
                professionalism_grade, professionalism_comment,
                clarity_grade, clarity_comment,
                problem_solving_grade, problem_solving_comment,
                objection_handling_grade, objection_handling_comment,
                closure_grade, closure_comment,
                summary, recommendations, created_at
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16)
            RETURNING chat_report_id
        """
        
        # Извлекаем данные из JSON
        params = (
            chat_id,
            analysis_data['tonality']['grade'],
            analysis_data['tonality']['comment'],
            analysis_data['professionalism']['grade'],
            analysis_data['professionalism']['comment'],
            analysis_data['clarity']['grade'],
            analysis_data['clarity']['comment'],
            analysis_data['problem_solving']['grade'],
            analysis_data['problem_solving']['comment'],
            analysis_data['objection_handling']['grade'],
            analysis_data['objection_handling']['comment'],
            analysis_data['closure']['grade'],
            analysis_data['closure']['comment'],
            analysis_data['summary'],
            analysis_data['recommendations'],
            datetime.now()
        )
        
        # Выполняем запрос
        async with db_pool.acquire() as connection:
            report_id = await connection.fetchval(query, *params)
            print(f"Отчет сохранен с ID: {report_id}")
            return report_id